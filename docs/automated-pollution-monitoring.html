<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Chapter 8 Automated Pollution Monitoring | Econ5/Poli5D</title>
<meta name="author" content="David Arnold">
<meta name="description" content="8.1 Principal Agent Problem   code {  background-color: #f1f1f1; } In economics and political science, there is a concept known as the principal agent problem. This setting arises when there is an...">
<meta name="generator" content="bookdown 0.30 with bs4_book()">
<meta property="og:title" content="Chapter 8 Automated Pollution Monitoring | Econ5/Poli5D">
<meta property="og:type" content="book">
<meta property="og:image" content="/images/geisel.jpg">
<meta property="og:description" content="8.1 Principal Agent Problem   code {  background-color: #f1f1f1; } In economics and political science, there is a concept known as the principal agent problem. This setting arises when there is an...">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Chapter 8 Automated Pollution Monitoring | Econ5/Poli5D">
<meta name="twitter:description" content="8.1 Principal Agent Problem   code {  background-color: #f1f1f1; } In economics and political science, there is a concept known as the principal agent problem. This setting arises when there is an...">
<meta name="twitter:image" content="/images/geisel.jpg">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.4.1/transition.js"></script><script src="libs/bs3compat-0.4.1/tabs.js"></script><script src="libs/bs3compat-0.4.1/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- CSS --><style type="text/css">
    
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  </style>
<style type="text/css">
    /* Used with Pandoc 2.11+ new --citeproc when CSL is used */
    div.csl-bib-body { }
    div.csl-entry {
      clear: both;
        }
    .hanging div.csl-entry {
      margin-left:2em;
      text-indent:-2em;
    }
    div.csl-left-margin {
      min-width:2em;
      float:left;
    }
    div.csl-right-inline {
      margin-left:2em;
      padding-left:1em;
    }
    div.csl-indent {
      margin-left: 2em;
    }
  </style>
<link rel="stylesheet" href="include/webex.css">
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">Econ5/Poli5D</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html">Introduction</a></li>
<li class="book-part">Excel</li>
<li><a class="" href="college-instruction-experiments.html"><span class="header-section-number">1</span> College Instruction Experiments</a></li>
<li class="book-part">Stata</li>
<li><a class="" href="intergenerational-mobility.html"><span class="header-section-number">2</span> Intergenerational Mobility</a></li>
<li><a class="" href="discrimination-in-police-stops.html"><span class="header-section-number">3</span> Discrimination in Police Stops</a></li>
<li><a class="" href="classroom-technology.html"><span class="header-section-number">4</span> Classroom Technology</a></li>
<li><a class="" href="legacy-of-colonial-medicine.html"><span class="header-section-number">5</span> Legacy of Colonial Medicine</a></li>
<li class="book-part">R</li>
<li><a class="" href="resume-experiments.html"><span class="header-section-number">6</span> Resume Experiments</a></li>
<li><a class="" href="the-rug-rat-race.html"><span class="header-section-number">7</span> The Rug Rat Race</a></li>
<li><a class="active" href="automated-pollution-monitoring.html"><span class="header-section-number">8</span> Automated Pollution Monitoring</a></li>
<li><a class="" href="voting.html"><span class="header-section-number">9</span> Voting</a></li>
<li><a class="" href="unconditional-cash-transfers.html"><span class="header-section-number">10</span> Unconditional Cash Transfers</a></li>
<li><a class="" href="references-1.html">References</a></li>
</ul>

        <div class="book-extra">
          
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="automated-pollution-monitoring" class="section level1" number="8">
<h1>
<span class="header-section-number">8</span> Automated Pollution Monitoring<a class="anchor" aria-label="anchor" href="#automated-pollution-monitoring"><i class="fas fa-link"></i></a>
</h1>
<div id="principal-agent-problem" class="section level2" number="8.1">
<h2>
<span class="header-section-number">8.1</span> Principal Agent Problem<a class="anchor" aria-label="anchor" href="#principal-agent-problem"><i class="fas fa-link"></i></a>
</h2>


<style>
code {
  background-color: #f1f1f1;
}
</style>
<p>In economics and political science, there is a concept known as the <strong>principal agent problem</strong>. This setting arises when there is an agent that is making decisions on behalf of a principal, but the agent and the principal's incentives may not align.</p>
<p>A classic example is employees at a firm. The employee is putting in some amount of effort to produce some output for the firm owner. The firm owner may want to produce as much output as possible, but the employee may balance output with the amount of effort it takes to produce that output. Therefore, their incentives do not necessarily align.</p>
<p>Another classic example is elected officials and the citizenry. The officials make decisions (i.e. the agents) acting on behalf of the citizens (i.e. the principal). However, the goal of the elected officials may be to be re-elected, not necessarily make the optimal decisions for the citizens. Therefore, in this setting as well, it is possible that the incentives are not necessarily aligned between the agent and the principal.</p>
<p>In this section, we will be discussing an interesting setting in which the principal agent problem is at play. In China, the central government (the principal) has recently made it a priority to reduce air pollution. To accomplish this, they provide high-power incentives to local governments (the agent) that achieve pollution targets. However, the local government officials are also the ones collecting the pollution data. While it may be costly to reduce air pollution, one possibility is that they can cheat and report pollution numbers lower than the actual pollution level.</p>
<p>Greenstone et al. (2022)<span class="citation"><a class="footnote-ref" tabindex="0" data-toggle="popover" data-content="&lt;p&gt;Michael Greenstone et al., &lt;span&gt;“Can Technology Solve the Principal-Agent Problem? Evidence from China’s War on Air Pollution,”&lt;/span&gt; &lt;em&gt;American Economic Review: Insights&lt;/em&gt; 4, no. 1 (2022): 54–70.&lt;/p&gt;"><sup>11</sup></a></span> studies this question by examining the introduction of automatic air pollution monitoring in China. This automated system was implemented in order to get accurate measures of pollution that cannot be manipulated by local officials. There are basically two potential outcomes of this analysis. First, local officials were reporting accurate numbers. In this case, we wouldn't expect automatic monitoring to change reported pollution numbers. The numbers are accurate both before and after the policy, and therefore, we expect the levels to be similar both before and after the policy.</p>
<p>The second possibility is that reported levels of pollution increase after automatic monitoring. If this is the case, then it suggests local governments were misreporting before automatic monitoring so that it would appear as if they are meeting pollution targets.</p>
<p>In order to measure pollution we will use reported PM10. This is a measure of particulates in the air that are 10 micrometers in diameter or smaller, and a common metric through which to measure air pollution. The focus of our coding this week will be on creating figures in R. We will create figures in both base R, as well as utilizing a popular graphics package, ggplot2. In the end, we will use our figures to understand whether local officials misreported pollution data in China.</p>
</div>
<div id="creating-histograms" class="section level2" number="8.2">
<h2>
<span class="header-section-number">8.2</span> Creating Histograms<a class="anchor" aria-label="anchor" href="#creating-histograms"><i class="fas fa-link"></i></a>
</h2>
<p>In this section, we are going to learn how to construct histograms in base R. To begin, we first need to load the data frame. However, the data we will be using <code>station_day_1116.dta</code> is a Stata dataset. In the past, we have only loaded in either RData or csv files.</p>
<p>In order to load in a Stata data set we are going to make use of the <code>haven</code> package. In order to install the haven package, you need to execute <code>install.packages("haven")</code>. Then, in your current R session you need to load the package using the <code><a href="https://rdrr.io/r/base/library.html">library()</a></code> function. Since we will again be utilizing the tidyverse in this section, we will also load the tidyverse package.</p>
<div class="sourceCode" id="cb363"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://haven.tidyverse.org">haven</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; ── Attaching core tidyverse packages ──── tidyverse 2.0.0 ──</span></span>
<span><span class="co">#&gt; ✔ dplyr     1.1.2     ✔ readr     2.1.4</span></span>
<span><span class="co">#&gt; ✔ forcats   1.0.0     ✔ stringr   1.5.0</span></span>
<span><span class="co">#&gt; ✔ ggplot2   3.4.2     ✔ tibble    3.2.1</span></span>
<span><span class="co">#&gt; ✔ lubridate 1.9.2     ✔ tidyr     1.3.0</span></span>
<span><span class="co">#&gt; ✔ purrr     1.0.1     </span></span>
<span><span class="co">#&gt; ── Conflicts ────────────────────── tidyverse_conflicts() ──</span></span>
<span><span class="co">#&gt; ✖ dplyr::filter() masks stats::filter()</span></span>
<span><span class="co">#&gt; ✖ dplyr::lag()    masks stats::lag()</span></span>
<span><span class="co">#&gt; ℹ Use the conflicted package (&lt;http://conflicted.r-lib.org/&gt;) to force all conflicts to become errors</span></span></code></pre></div>
<p>The <code>haven</code> package comes with a function <code>read_dta</code>, which will read in a <code>.dta</code> file as a tibble.</p>
<div class="sourceCode" id="cb364"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://haven.tidyverse.org/reference/read_dta.html">read_dta</a></span><span class="op">(</span><span class="st">"station_day_1116.dta"</span><span class="op">)</span></span></code></pre></div>
<p>To first get a sense of our data, let's look at a few of the key variables in this dataset.</p>
<div class="sourceCode" id="cb365"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pm</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">pm10_n</span>,<span class="va">code_city</span>,<span class="va">date</span>,<span class="va">pm10</span>,<span class="va">auto_date</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 1,433,568 × 5</span></span>
<span><span class="co">#&gt;    pm10_n code_city  date  pm10 auto_date</span></span>
<span><span class="co">#&gt;     &lt;dbl&gt;     &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;     &lt;dbl&gt;</span></span>
<span><span class="co">#&gt;  1     46    440300 18628  NA       19060</span></span>
<span><span class="co">#&gt;  2     46    440300 18629  NA       19060</span></span>
<span><span class="co">#&gt;  3     46    440300 18630  NA       19060</span></span>
<span><span class="co">#&gt;  4     46    440300 18631  NA       19060</span></span>
<span><span class="co">#&gt;  5     46    440300 18632  NA       19060</span></span>
<span><span class="co">#&gt;  6     46    440300 18633  NA       19060</span></span>
<span><span class="co">#&gt;  7     46    440300 18634  70.1     19060</span></span>
<span><span class="co">#&gt;  8     46    440300 18635 114.      19060</span></span>
<span><span class="co">#&gt;  9     46    440300 18636  62.5     19060</span></span>
<span><span class="co">#&gt; 10     46    440300 18637  90.8     19060</span></span>
<span><span class="co">#&gt; # ℹ 1,433,558 more rows</span></span></code></pre></div>
<p>The first variable, <code>pm10_n</code> is the station number. This is the code of the station that took the pollution reading. The next variable <code>code_city</code> is the code of the city in which the pollution reading was taken. This dataset is a panel dataset, which means there are many observations over time. In this case, we will have readings from the same pollution center over time. The <code>date</code> variable stores information on the date the reading was taken. We will discuss a bit later what the number in this variable means. <code>pm10</code> is our measure of pollution. Lastly, <code>auto_date</code> is the date of automation. After this date, instead of local governments reporting pollution statistics, pollution statistics were directly reported to the central government.</p>
<p>So for this section our goal is to create a histogram that shows the distribution of <code>pm10</code> across cities. Right now, we have a dataset that is at the station-date level. Each row corresponds to a pollution level at a particular station. We want to transform our data into a dataset that has for every city, the average level of pollution in that city.</p>
<p>The way we can do this is to use <code><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by()</a></code> and <code><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize()</a></code>, as we did in the prior chapter. If you recall, when you want to create a tibble of summary statistics by a group, we use <code><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by()</a></code> in combination with <code><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize()</a></code>. In this example, the group variable is the <code>code_city</code> and the summary statistic is the average level of <code>pm10</code>.</p>
<div class="sourceCode" id="cb366"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pm_bycity</span> <span class="op">&lt;-</span> <span class="va">pm</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">code_city</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span>meanpm10 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">pm10</span>, na.rm<span class="op">=</span><span class="cn">T</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>We have included <code>na.rm=T</code>, because looking through the <code>pm10</code> variable, it appears there is some missing data. Adding <code>na.rm=T</code> indicates we are taking the average over the non-missing values.</p>
<p>So now, for each unique value of <code>code_city</code>, we have the average of the PM10 level in that city and have saved this information in the tibble <code>pm_bycity</code>.</p>
<p>To generate histograms in base R, we can use the <code><a href="https://rdrr.io/r/graphics/hist.html">hist()</a></code> function. For example, let's generate a histogram of <code>pm10</code>:</p>
<div class="sourceCode" id="cb367"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/hist.html">hist</a></span><span class="op">(</span><span class="va">pm_bycity</span><span class="op">$</span><span class="va">meanpm10</span><span class="op">)</span></span></code></pre></div>
<div class="figure" style="text-align: center">
<span style="display:block;" id="fig:hist1"></span>
<img src="08-week8_files/figure-html/hist1-1.png" alt="Histogram of Average Pollution Levels Across Cities Part 1" width="80%"><p class="caption">
Figure 8.1: Histogram of Average Pollution Levels Across Cities Part 1
</p>
</div>
<p>First, let's review a histogram. On the horizontal axis, we have our numeric variable <code>meanpm10</code>, which is the average level of <code>pm10</code> in a city. The histogram has binned this variable into discrete intervals. R automatically creates these bins when you use the <code><a href="https://rdrr.io/r/graphics/hist.html">hist()</a></code> function. Then, in the vertical axis, the number of cities that fall within that interval is presented. So, for example, if we look at the tallest bin, which is about 80-100, we can see there are about 35 cities with average pollution in that range.</p>
<p>While this presents our information, there is a lot we can do in order to improve this figure. For example, the title right now is not clear. A reader may not know what <code>pm_bycity$meanpm10</code> means. As usual, we will want to improve these labels.</p>
<p>To change the axis labels, we can use <code>xlab="Horizontal Axis Name"</code> and <code>ylab="Vertical Axis Name"</code>. To add a title, we can use <code>main="Title Name"</code>. <code>main</code> is perhaps not the most intuitive name for the options that generates a title, but you can think of it is "What is the main subject for this plot". So let's try to re-create our plot with better axes labels and titles.</p>
<div class="sourceCode" id="cb368"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/hist.html">hist</a></span><span class="op">(</span><span class="va">pm_bycity</span><span class="op">$</span><span class="va">meanpm10</span>, </span>
<span>     xlab<span class="op">=</span><span class="st">"Mean PM10"</span>, </span>
<span>     ylab<span class="op">=</span><span class="st">"Frequency"</span>, </span>
<span>     main<span class="op">=</span><span class="st">"Mean PM10 by City"</span><span class="op">)</span></span></code></pre></div>
<div class="figure" style="text-align: center">
<span style="display:block;" id="fig:hist2"></span>
<img src="08-week8_files/figure-html/hist2-1.png" alt="Histogram of Average Pollution Levels Across Cities Part 2" width="80%"><p class="caption">
Figure 8.2: Histogram of Average Pollution Levels Across Cities Part 2
</p>
</div>
<p>These various options will be useful for many different types of graphs in base R, not just histograms. For example, later we will generate a scatter plot. We can use these same options when generating this alternate type of graph.</p>
<p>Next, let's discuss ways in which we can customize the look of our plot. For example, with histograms, one common way to customize the plot is to change the number of bins that are created. R chooses a default number of bins, but you can manually change this by using the <code>breaks</code> option. If you specify a higher number for <code>breaks</code>, that means you want more bins. If you specify a lower number, that means you want fewer bins.</p>
<p>To illustrate this, we are going to put two plots side-by-side. Learning how to put two plots side-by-side is a generally useful technique as well. Often in academic articles, you might see multiple panels in a figure if the information between the panels is closely related. In our example, we are going to create two plots, one with many bins and another with few bins.</p>
<p>The way to tell R to create multiple plots is to use the function called <code><a href="https://rdrr.io/r/graphics/par.html">par()</a></code>. Within <code><a href="https://rdrr.io/r/graphics/par.html">par()</a></code> you can use an argument called <code>mfrow=</code>. <code>mfrow=</code> tells R how many rows and how many columns you want in your plot. For example, in our example, we want on a single row, two separate figures. You can think of this as a row of figures, but two columns of figures. To specify this in R, you can type <code>mfrow=c(1,2)</code>.</p>
<div class="sourceCode" id="cb369"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span>mfrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#Smaller bins</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/hist.html">hist</a></span><span class="op">(</span><span class="va">pm_bycity</span><span class="op">$</span><span class="va">meanpm10</span>, xlab<span class="op">=</span><span class="st">"Mean PM10"</span>, </span>
<span>     ylab<span class="op">=</span><span class="st">"Frequency"</span>, main<span class="op">=</span><span class="st">"Mean PM10 by City"</span>,</span>
<span>     breaks<span class="op">=</span><span class="fl">20</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#Larger bins</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/hist.html">hist</a></span><span class="op">(</span><span class="va">pm_bycity</span><span class="op">$</span><span class="va">meanpm10</span>, xlab<span class="op">=</span><span class="st">"Mean PM10"</span>, </span>
<span>     ylab<span class="op">=</span><span class="st">"Frequency"</span>, main<span class="op">=</span><span class="st">"Mean PM10 by City"</span>,</span>
<span>     breaks<span class="op">=</span><span class="fl">4</span><span class="op">)</span></span></code></pre></div>
<div class="figure" style="text-align: center">
<span style="display:block;" id="fig:hist3"></span>
<img src="08-week8_files/figure-html/hist3-1.png" alt="Histogram of Average Pollution Levels Across Cities Part 3" width="90%"><p class="caption">
Figure 8.3: Histogram of Average Pollution Levels Across Cities Part 3
</p>
</div>
<p>As you can see, when we specify <code>breaks=20</code>, the histogram function generates many bins. When we specified <code>breaks=4</code>, we retrieve only 4 bins.</p>
<p>So generally there is a trade off in the number of bins you create. In the left plot, we get more fine-grained information about the distribution of <code>pm10</code> across cities. On the right, the information is more aggregated, but perhaps easier to read. In many cases, the default number of bins (i.e. the choice automatically made by R when you do not specify <code>breaks</code>) is a good choice.</p>
</div>
<div id="comparing-histograms" class="section level2" number="8.3">
<h2>
<span class="header-section-number">8.3</span> Comparing Histograms<a class="anchor" aria-label="anchor" href="#comparing-histograms"><i class="fas fa-link"></i></a>
</h2>
<p>In this section we will discuss how to compare two histograms. In particular, we will plot this distribution of pollution levels (PM10) both before and after the implementation of automatic monitoring</p>
<p>Before we construct these histograms, we need to compute a data frame that contains average pollution levels by city, both before and after automation. We can accomplish this by first constructing a variable <code>T</code> that contains days until automation. Then we can filter to days before automation (<code>T&lt;0</code>). Similarly, we can create a post-automation data frame by filtering to observations such that <code>T&gt;0</code>. We can accomplish all of this in one step by using the pipe operator:</p>
<div class="sourceCode" id="cb370"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pm_bycitybefore</span> <span class="op">&lt;-</span> <span class="va">pm</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>T<span class="op">=</span><span class="va">date</span><span class="op">-</span><span class="va">auto_date</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="cn">T</span><span class="op">&lt;</span><span class="fl">0</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">code_city</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span>meanpm10 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">pm10</span>, na.rm<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>So let's make sure we understand each line of code. <code>pm %&gt;%</code> pipes in the data frame <code>pm</code>. <code>mutate(T=date-auto_date)</code> creates a new variable and adds it to the data frame. The name of this new variable is <code>T</code>. If <code>T</code> is negative, that means <code>date</code> is less than <code>auto_date</code>. Next <code>filter(T&lt;0)</code> implies we are restricting to observations before the automation date. Lastly, <code>group_by(code_city) %&gt;% summarize(meanpm10=mean(pm10, na.rm=T))</code> implies we are taking averages of <code>pm10</code> by city. In the end, we will have a dataset where each observation is a separate city, and we have the average level of <code>pm10</code> in that city before automation. We can use analogous code to construct a city-level dataset that has the average level of <code>pm10</code> after automation.</p>
<div class="sourceCode" id="cb371"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pm_bycityafter</span> <span class="op">&lt;-</span> <span class="va">pm</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>T<span class="op">=</span><span class="va">date</span><span class="op">-</span><span class="va">auto_date</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="cn">T</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>   <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">code_city</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span>meanpm10 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">pm10</span>, na.rm<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Next, we will create two plots that lie side-by-side. In order to do this, we will again specify <code>par(mfrow=c(1,2))</code> before generating the plots.</p>
<div class="sourceCode" id="cb372"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span>mfrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#Plot histogram for before</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/hist.html">hist</a></span><span class="op">(</span><span class="va">pm_bycitybefore</span><span class="op">$</span><span class="va">meanpm10</span>, xlab<span class="op">=</span><span class="st">"MeanPM10"</span>, </span>
<span>  ylab<span class="op">=</span><span class="st">"Frequency"</span>,</span>
<span>  main<span class="op">=</span><span class="st">"Before Automation"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#Plot histogram for after</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/hist.html">hist</a></span><span class="op">(</span><span class="va">pm_bycityafter</span><span class="op">$</span><span class="va">meanpm10</span>, xlab<span class="op">=</span><span class="st">"MeanPM10"</span>, </span>
<span>  ylab<span class="op">=</span><span class="st">"Frequency"</span>,</span>
<span>  main<span class="op">=</span><span class="st">"After Automation"</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="08-week8_files/figure-html/unnamed-chunk-10-1.png" width="90%"></div>
<p>In these plots it is not so easy to compare the two distributions. One reason is that they are not on the same scale. As you can see, the x-axis in the After Automation plot goes up to 200, while in the Before Automation plot it goes up to 150. In order for the two to be directly comparable, we should ensure that both the x-axis and the y-axis have the same scale. We can do this using the <code><a href="https://ggplot2.tidyverse.org/reference/lims.html">xlim()</a></code> and <code><a href="https://ggplot2.tidyverse.org/reference/lims.html">ylim()</a></code> functions. In the code below, we specify <code>xlim=c(0,250)</code>. This implies the x-axis will start at 0 and go up to 250. We specify <code>ylim=c(0,50)</code>. This implies the y-axis will start at 0 and go up to 50.</p>
<div class="sourceCode" id="cb373"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#Create two panes for plots</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span>mfrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#Plot histogram for before</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/hist.html">hist</a></span><span class="op">(</span><span class="va">pm_bycitybefore</span><span class="op">$</span><span class="va">meanpm10</span>, xlab<span class="op">=</span><span class="st">"MeanPM10"</span>, </span>
<span>  ylab<span class="op">=</span><span class="st">"Frequency"</span>,</span>
<span>  main<span class="op">=</span><span class="st">"Before automation"</span>,</span>
<span>  xlim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">250</span><span class="op">)</span>, ylim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">50</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#Plot histogram for after</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/hist.html">hist</a></span><span class="op">(</span><span class="va">pm_bycityafter</span><span class="op">$</span><span class="va">meanpm10</span>, xlab<span class="op">=</span><span class="st">"MeanPM10"</span>, </span>
<span>  ylab<span class="op">=</span><span class="st">"Frequency"</span>,</span>
<span>  main<span class="op">=</span><span class="st">"After automation"</span>,</span>
<span>  xlim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">250</span><span class="op">)</span>, ylim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">50</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="08-week8_files/figure-html/unnamed-chunk-11-1.png" width="90%"></div>
<p>Now we can more clearly compare the two plots. Before automation, many of the pm10 averages seem to be clustered just below 100. After automation, the distribution is more sspread out, with many observations above 100, and even some above 200. Before automation, no city had an average level of pm10 above 200. Therefore, it appears as if the distribution of <strong>reported</strong> pm10 has shifted to the right after automation.</p>
<p>Lastly, we can also add additional information to the plot. For example, it might be helpful to quickly be able to understand how the average level of pm10 varies before and after automation. We can add these numbers to the plots by using the <code><a href="https://rdrr.io/r/graphics/lines.html">lines()</a></code> function. The way the lines function works is that you specify <span class="math inline">\((x_1, x_2)\)</span> and <span class="math inline">\((y_1,y_2)\)</span>. The line starts at the point <span class="math inline">\((x_1,y_1)\)</span> and ends at <span class="math inline">\((x_2,y_2)\)</span>. Therefore, if we want to have a vertical line at the mean we can specify <code>lines(c(mean,mean),c(-10,100))</code>. We have specified <code>c(-10,100)</code> because these numbers are beyond the limits of the graph. Therefore, the vertical line will appear along the entire graph output. To understand how to build lines on graphs, it is helpful to change the numbers in the code below and see how the results change.</p>
<div class="sourceCode" id="cb374"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">meanbefore</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">pm_bycitybefore</span><span class="op">$</span><span class="va">meanpm10</span><span class="op">)</span></span>
<span><span class="va">meanafter</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">pm_bycityafter</span><span class="op">$</span><span class="va">meanpm10</span><span class="op">)</span></span>
<span><span class="co">#Create two panes for plots</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span>mfrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#Plot histogram for before</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/hist.html">hist</a></span><span class="op">(</span><span class="va">pm_bycitybefore</span><span class="op">$</span><span class="va">meanpm10</span>, xlab<span class="op">=</span><span class="st">"MeanPM10"</span>,</span>
<span>  ylab<span class="op">=</span><span class="st">"Frequency"</span>,</span>
<span>  main<span class="op">=</span><span class="st">"Before Automation"</span>,</span>
<span>  xlim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">250</span><span class="op">)</span>, ylim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">50</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/lines.html">lines</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">meanbefore</span>, <span class="va">meanbefore</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">10</span>, <span class="fl">100</span><span class="op">)</span>, </span>
<span>  lty<span class="op">=</span><span class="fl">2</span>, col<span class="op">=</span><span class="st">"red"</span><span class="op">)</span></span>
<span><span class="co">#Plot histogram for after</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/hist.html">hist</a></span><span class="op">(</span><span class="va">pm_bycityafter</span><span class="op">$</span><span class="va">meanpm10</span>, xlab<span class="op">=</span><span class="st">"MeanPM10"</span>, </span>
<span>  ylab<span class="op">=</span><span class="st">"Frequency"</span>,</span>
<span>  main<span class="op">=</span><span class="st">"After Automation"</span>,</span>
<span>  xlim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">250</span><span class="op">)</span>, ylim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">50</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/lines.html">lines</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">meanafter</span>, <span class="va">meanafter</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">10</span>, <span class="fl">100</span><span class="op">)</span>, </span>
<span>  lty<span class="op">=</span><span class="fl">2</span>, col<span class="op">=</span><span class="st">"red"</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="08-week8_files/figure-html/unnamed-chunk-12-1.png" width="672"></div>
</div>
<div id="boxplots" class="section level2" number="8.4">
<h2>
<span class="header-section-number">8.4</span> Boxplots<a class="anchor" aria-label="anchor" href="#boxplots"><i class="fas fa-link"></i></a>
</h2>
<p>A box plot is a figure we have not yet seen in this course. Like a histogram, it is informative about the distribution of a variable. In particular, a box plot shows a few key statistics of interest, including the median, the 25th precentile and 75th percentile. It is often helpful when you want to show how the distribution of a variable varies across different groups. For example, maybe you are interested in variation in test scores across different classes in a school. Maybe you are interested in how the distribution of wages across different regions of the U.S. In these types of instances, box plots might be an effective way to present your information.</p>
<p>In our example, we are going to construct a box plot that shows the average daily pm10 levels both before and after automation. To begin, we are again going to use <code><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by()</a></code> and <code><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize()</a></code> to construct a relevant dataset.</p>
<div class="sourceCode" id="cb375"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#Group by day</span></span>
<span><span class="va">pm_byday</span> <span class="op">&lt;-</span> <span class="va">pm</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>    T<span class="op">=</span><span class="va">date</span><span class="op">-</span><span class="va">auto_date</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="cn">T</span><span class="op">&gt;</span><span class="op">-</span><span class="fl">364</span>, <span class="cn">T</span><span class="op">&lt;</span><span class="fl">364</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="cn">T</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span>meanpm10 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">pm10</span>, na.rm<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>So in this example, <code>T</code> is again the days until automation. For this box plot, we are restricting to within a year of the automation date <code>filter(T&gt;-364, T&lt;364)</code>. Because we have grouped by <code>T</code>, our resulting dataset will have a single observation per day, with the corresponding variable being the average level of pollution on that day. To construct a box plot we can use the <code><a href="https://rdrr.io/r/graphics/boxplot.html">boxplot()</a></code> function:</p>
<div class="sourceCode" id="cb376"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/boxplot.html">boxplot</a></span><span class="op">(</span><span class="va">pm_byday</span><span class="op">$</span><span class="va">meanpm10</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="08-week8_files/figure-html/unnamed-chunk-14-1.png" width="80%"></div>
<p>The box plot has a few elements that we should discuss. First, the upper end of the box is the 75th percentile (also referred to as the third quartile). In this box plot, the 75th percentile is at about 112. The bottom of the box is the 25th percentile (also referred to as the 1st quartile). In this box plot, the 25th percentile is about 80. The length of the box is referred to as the interquartile range. This is the difference between the 75th percentile and the 25th percentile, so in this example the interquartile range is 112-80=32.</p>
<p>The dashed lines that extend from the box are referred to as whiskers. The length of the whiskers is equal to <span class="math inline">\(1.5 \cdot IQR\)</span>. So in this example, the whiskers extend for about <span class="math inline">\(32 \cdot 1.5 = 48\)</span>. However, the whiskers only extend this length as long as there is data in that range. For example, theoretically, the bottom whisker should extend to <span class="math inline">\(80-48=32\)</span>. The reason it does not in the figure is because there is no data at this point. Instead, the whisker extends to the minimum, which is about 53 in this figure.</p>
<p>As you can see, the upper whisker is longer and extends to <span class="math inline">\(112+48=160\)</span>. Further, we can see there are dots beyond the whisker. This signifies that there is data beyond the values reached by the whisker. These dots give us a sense of how many outliers there are in the data.</p>
<p>Just as in other figures, we can also improve the aesthetics of the box plot in various ways. For example, the box plot below adds appropriate labels, changes the colors of the box plot, as well as changes the orientation of the box plot.</p>
<div class="sourceCode" id="cb377"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/boxplot.html">boxplot</a></span><span class="op">(</span><span class="va">pm_byday</span><span class="op">$</span><span class="va">meanpm10</span>, xlab<span class="op">=</span><span class="st">"Mean PM10"</span>, </span>
<span>main<span class="op">=</span><span class="st">"Mean PM 10 by city"</span>,</span>
<span>  col<span class="op">=</span><span class="st">"blue"</span>, border<span class="op">=</span><span class="st">"darkblue"</span>, </span>
<span>  pch<span class="op">=</span><span class="fl">16</span>, horizontal<span class="op">=</span><span class="cn">T</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="08-week8_files/figure-html/unnamed-chunk-15-1.png" width="75%"></div>
<p>It is actually relatively uncommon to see a single box plot. What is often useful, however, is to display box plots across different groups. Therefore, in the next figure we will have separate box plots for before and after automation.</p>
<p>First, we need to add a variable that indicates whether the time is before or after automation.</p>
<div class="sourceCode" id="cb378"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pm_byday</span><span class="op">$</span><span class="va">after</span> <span class="op">&lt;-</span> <span class="va">pm_byday</span><span class="op">$</span><span class="cn">T</span><span class="op">&gt;</span><span class="fl">0</span></span></code></pre></div>
<p>What is the code above accomplishing? It is creating a binary logical variable that is equal to <code>TRUE</code> if it is after automation, and equal to <code>FALSE</code> if it is before automation. Remember, values of <code>T</code> that are positive are days after automation has occured.</p>
<p>To plot separate box plots by the value of <code>after</code>, we specify <code>pm_byday$meanpm10 ~ pm_byday$after</code> inside the boxplot function, rather than just <code>pm_byday$meanpm10</code>.</p>
<div class="sourceCode" id="cb379"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/boxplot.html">boxplot</a></span><span class="op">(</span><span class="va">pm_byday</span><span class="op">$</span><span class="va">meanpm10</span> <span class="op">~</span> <span class="va">pm_byday</span><span class="op">$</span><span class="va">after</span>, </span>
<span>        xlab<span class="op">=</span><span class="st">"Mean PM10"</span>, ylab<span class="op">=</span><span class="st">"After Automation"</span>,</span>
<span>        main<span class="op">=</span><span class="st">"Mean PM 10 by Day Before and After Automation"</span>, </span>
<span>        col<span class="op">=</span><span class="st">"blue"</span>, border<span class="op">=</span><span class="st">"darkblue"</span>, </span>
<span>        pch<span class="op">=</span><span class="fl">16</span>, horizontal<span class="op">=</span><span class="cn">T</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="08-week8_files/figure-html/unnamed-chunk-17-1.png" width="75%"></div>
<p>What can we tell from this figure? Well, after automation pollution levels seem to be higher. The 25th percentile, median, and 75th percentile are all higher. Additionally, the minimum and maximum levels have also shifted dramatically. Before, the minimum pollution level was around 53, while after it is closer to 75. Before, the maximum level topped out just below 140. After we have a day with pollution levels at almost 200. It appears there is a large increase in reported pollution levels after automation, providing evidence that local governments under-reported pollution levels before automatic monitoring.</p>
</div>
<div id="scatterplots" class="section level2" number="8.5">
<h2>
<span class="header-section-number">8.5</span> Scatterplots<a class="anchor" aria-label="anchor" href="#scatterplots"><i class="fas fa-link"></i></a>
</h2>
<p>In this section we will analyze how pollution changes day-to-day around automation. In order to do this, we will plot daily pollution levels around the time of automation. Therefore, we will continue to use the data set <code>pm_byday</code> which includes for each day relative to automation, the average pollution level.</p>
<p>The general syntax for a scatterplot is:</p>
<div class="sourceCode" id="cb380"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">df</span><span class="op">$</span><span class="va">xvar</span>, <span class="va">df</span><span class="op">$</span><span class="va">yvar</span><span class="op">)</span></span></code></pre></div>
<p>We want a plot in which the x-axis depicts the day relative to automation while y-axis depicts average pollution levels. Therefore, we will replace <code>df$xvar</code> with <code>pm_bydat$T</code> and <code>df$yvar</code> with <code>pm_byday$meanpm10</code>. As in other plots we will add labels to clarify the plot.</p>
<div class="sourceCode" id="cb381"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">pm_byday</span><span class="op">$</span><span class="cn">T</span>, <span class="va">pm_byday</span><span class="op">$</span><span class="va">meanpm10</span>,</span>
<span>    xlab<span class="op">=</span><span class="st">"Days Relative to Automation"</span>,</span>
<span>    ylab<span class="op">=</span><span class="st">"Mean PM10"</span>, </span>
<span>    main<span class="op">=</span><span class="st">"Automation and Mean PM10"</span>,<span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="08-week8_files/figure-html/unnamed-chunk-19-1.png" width="80%"></div>
<p>There are many further ways we can customize the plot. For example, we could change what the markers appear as. <code>pch</code> stands for plot character. To make the circles solid instead of hollow, we can specify <code>pch=16</code>.</p>
<div class="sourceCode" id="cb382"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">pm_byday</span><span class="op">$</span><span class="cn">T</span>, <span class="va">pm_byday</span><span class="op">$</span><span class="va">meanpm10</span>,</span>
<span>    xlab<span class="op">=</span><span class="st">"Days Relative to Automation"</span>,</span>
<span>    ylab<span class="op">=</span><span class="st">"Mean PM10"</span>, </span>
<span>    main<span class="op">=</span><span class="st">"Automation and Mean PM10"</span>,</span>
<span>    pch<span class="op">=</span><span class="fl">16</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="08-week8_files/figure-html/unnamed-chunk-20-1.png" width="80%"></div>
<p>What would be particularly helpful is to have the reader understand when automation is occurring. Therefore, let's add a dashed line at 0 (the time automation occurs) and add additional text in order to label this line. We can again add lines through the <code><a href="https://rdrr.io/r/graphics/lines.html">lines()</a></code> function. To add text we need to specify (1) where to place the text and (2) what text should appear. For example, to place text at <code>(x=0,y=260)</code>, we would type <code>text(0,260, "Text Here")</code>. Let's try this in our scatter plot and additionally show how to change the color of the text.</p>
<div class="sourceCode" id="cb383"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">pm_byday</span><span class="op">$</span><span class="cn">T</span>, <span class="va">pm_byday</span><span class="op">$</span><span class="va">meanpm10</span>, </span>
<span>     xlab<span class="op">=</span><span class="st">"Days After Automation"</span>,</span>
<span>     ylab<span class="op">=</span><span class="st">"Mean PM10"</span>, main<span class="op">=</span><span class="st">"Automation and Mean PM10"</span>,</span>
<span>     pch<span class="op">=</span><span class="fl">16</span>, ylim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">300</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/lines.html">lines</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">10</span>,<span class="fl">250</span><span class="op">)</span>, col<span class="op">=</span><span class="st">"red"</span>, lty<span class="op">=</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/text.html">text</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">260</span>, <span class="st">"Automation"</span>, col<span class="op">=</span><span class="st">"red"</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="08-week8_files/figure-html/unnamed-chunk-21-1.png" width="80%"></div>
<p>Finally, let's discuss how to actually save our plots. Saving plots consists of three steps:</p>
<ul>
<li><ol style="list-style-type: decimal">
<li>Use <code><a href="https://rdrr.io/r/grDevices/pdf.html">pdf()</a></code> of <code><a href="https://rdrr.io/r/grDevices/png.html">png()</a></code> to create the file where the plot will be created.</li>
</ol></li>
<li><ol start="2" style="list-style-type: decimal">
<li>Run the code to create the plot.</li>
</ol></li>
<li><ol start="3" style="list-style-type: decimal">
<li>Type <code><a href="https://rdrr.io/r/grDevices/dev.html">dev.off()</a></code> to tell R you are done creating plots.</li>
</ol></li>
</ul>
<p>For example, let's say we want to save a PDF of our plot and we want it named <code>Automation.pdf</code>. Our first step is to execute the code:</p>
<div class="sourceCode" id="cb384"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/grDevices/pdf.html">pdf</a></span><span class="op">(</span><span class="st">"Automation.pdf"</span><span class="op">)</span></span></code></pre></div>
<p>This will create a file named <code>Automation.pdf</code> in your current working directory. This will eventually hold our plot. Next, we need to re-run the code to create our plot:</p>
<div class="sourceCode" id="cb385"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">pm_byday</span><span class="op">$</span><span class="cn">T</span>, <span class="va">pm_byday</span><span class="op">$</span><span class="va">meanpm10</span>, </span>
<span>     xlab<span class="op">=</span><span class="st">"Days After Automation"</span>,</span>
<span>     ylab<span class="op">=</span><span class="st">"Mean PM10"</span>, main<span class="op">=</span><span class="st">"Automation and Mean PM10"</span>,</span>
<span>     pch<span class="op">=</span><span class="fl">16</span>, ylim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">300</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/lines.html">lines</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">10</span>,<span class="fl">250</span><span class="op">)</span>, col<span class="op">=</span><span class="st">"red"</span>, lty<span class="op">=</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/text.html">text</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">260</span>, <span class="st">"Automation"</span>, col<span class="op">=</span><span class="st">"red"</span><span class="op">)</span></span></code></pre></div>
<p>Now that the plot has been generated, we need to execute:</p>
<div class="sourceCode" id="cb386"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/grDevices/dev.html">dev.off</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>If you forget to execute <code><a href="https://rdrr.io/r/grDevices/dev.html">dev.off()</a></code> then the next plot you execute will also be written to <code>Automation.pdf</code>.</p>
</div>
<div id="dates" class="section level2" number="8.6">
<h2>
<span class="header-section-number">8.6</span> Dates<a class="anchor" aria-label="anchor" href="#dates"><i class="fas fa-link"></i></a>
</h2>
<p>Dates can often be difficult to work when performing data analysis. In this section we are going to study a package called <code>lubridate</code> that can be very helpful when working with dates in R.</p>
<p>As <code>lubridate()</code> is a new package, you first need to install lubridate via <code>install.packages("lubridate")</code> and then load into memory using the <code><a href="https://rdrr.io/r/base/library.html">library()</a></code> function:</p>
<div class="sourceCode" id="cb387"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://lubridate.tidyverse.org">lubridate</a></span><span class="op">)</span></span></code></pre></div>
<p><code>lubridate()</code> comes with a variety of functions. For example, there are functions to tell you what day it is today:</p>
<div class="sourceCode" id="cb388"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/now.html">today</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "2024-03-11"</span></span></code></pre></div>
<p>Or even the exact time right now:</p>
<div class="sourceCode" id="cb389"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/now.html">now</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "2024-03-11 14:39:36 PDT"</span></span></code></pre></div>
<p>But most importantly, <code>lubridate</code> allows R to interpret strings of text as dates. For us, that means when we make a graph R will understand that an observation for January 1, 2012 was taken before an observation that was taken on March 3rd, 2014, for example.</p>
<p>Additionally, <code>lubridate()</code> can interpret dates that come in a variety of formats. For example, we can use the <code><a href="https://lubridate.tidyverse.org/reference/ymd.html">ymd()</a></code> function to convert a string of text that holds the date as <code>"year-month-day"</code> into a date object.</p>
<div class="sourceCode" id="cb390"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/ymd.html">ymd</a></span><span class="op">(</span><span class="st">"2012-01-22"</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "2012-01-22"</span></span></code></pre></div>
<p>There is also a month-day-year function:</p>
<div class="sourceCode" id="cb391"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/ymd.html">mdy</a></span><span class="op">(</span><span class="st">"January 22nd, 2012"</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "2012-01-22"</span></span></code></pre></div>
<p>Or a day-month-year function:</p>
<div class="sourceCode" id="cb392"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/ymd.html">dmy</a></span><span class="op">(</span><span class="st">"22-Jan-2012"</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "2012-01-22"</span></span></code></pre></div>
<p>What is also important is that we can add days and times with <code>lubridate</code> functions. For example, 12 days after January 22nd 2012 is:</p>
<div class="sourceCode" id="cb393"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/ymd.html">ymd</a></span><span class="op">(</span><span class="st">"2012-01-22"</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/period.html">days</a></span><span class="op">(</span><span class="fl">12</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "2012-02-03"</span></span></code></pre></div>
<p>In 15 months it will be:</p>
<div class="sourceCode" id="cb394"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/ymd.html">ymd</a></span><span class="op">(</span><span class="st">"2012-01-22"</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/weekday.POSIXt.html">months</a></span><span class="op">(</span><span class="fl">15</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "2013-04-22"</span></span></code></pre></div>
<p>In 5 years it will be:</p>
<div class="sourceCode" id="cb395"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/ymd.html">ymd</a></span><span class="op">(</span><span class="st">"2012-01-22"</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/period.html">years</a></span><span class="op">(</span><span class="fl">5</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "2017-01-22"</span></span></code></pre></div>
<p>Often the date is actually more narrow than we need for our analysis. For example, maybe we only need the year portion of the date variable. We can extract this portion using the <code><a href="https://lubridate.tidyverse.org/reference/year.html">year()</a></code> function:</p>
<div class="sourceCode" id="cb396"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/year.html">year</a></span><span class="op">(</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/ymd.html">ymd</a></span><span class="op">(</span><span class="st">"2012-01-22"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 2012</span></span></code></pre></div>
<p>There are similar functions for extracting the month(<code><a href="https://lubridate.tidyverse.org/reference/month.html">month()</a></code>), day in the month (<code><a href="https://lubridate.tidyverse.org/reference/day.html">mday()</a></code>), or day of the week <code><a href="https://lubridate.tidyverse.org/reference/day.html">wday()</a></code>.</p>
<p>Now that we have a sense of <code>lubridate()</code> let's load return to the pollution monitoring data frame <code>pm</code>. In this data frame, let's look at the variable <code>date</code>.</p>
<div class="sourceCode" id="cb397"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">pm</span><span class="op">$</span><span class="va">date</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 18628 18629 18630 18631 18632 18633</span></span></code></pre></div>
<p>So this doesn't look very intuitive. What does 18628. Well, this is actually an artifact of how Stata stores dates (recall we originally read the data frame into R via a Stata dataset). It stores dates as the number of days since January 1, 1960.</p>
<p>In other words, <code>18628</code> represents that this observation was taken <code>18628</code> days after January 1, 1960. We can figure out what day this is exactly by using functions from lubridate:</p>
<div class="sourceCode" id="cb398"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/ymd.html">ymd</a></span><span class="op">(</span><span class="st">"1960-01-01"</span><span class="op">)</span><span class="op">+</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/period.html">days</a></span><span class="op">(</span><span class="fl">18628</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "2011-01-01"</span></span></code></pre></div>
<p>So 18628 days from January 1, 1960 is January 1, 2011.</p>
<p>Next, we are going to study rainfall over time. Rain may actually reduce the amount of pollution in the air. When rain falls, it attracts particles in the air before hitting the ground, in turn reducing the amount of pollution in the air. Therefore, we may expect to see natural changes in pollution throughout the year due to changes in the amount of rain. To understand seasonality of rainfall in China, we are going to make plots that show how rainfall varies over time.</p>
<p>First, let's get a sense of how rainfall varies by the month. Let's create a data frame that has for each month of the year, the average level of rain. The variable <code>rain</code> in our data frame records the daily rainfall in mm. To create this data frame we are again going to utilize <code><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by()</a></code> and <code><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize()</a></code>.</p>
<div class="sourceCode" id="cb399"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pm_bymonth</span> <span class="op">&lt;-</span> <span class="va">pm</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>rdate <span class="op">=</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/ymd.html">ymd</a></span><span class="op">(</span><span class="st">"1960-01-01"</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/period.html">days</a></span><span class="op">(</span><span class="va">date</span><span class="op">)</span>,</span>
<span>    month <span class="op">=</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/month.html">month</a></span><span class="op">(</span><span class="va">rdate</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">month</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span>meanrain <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">rain</span>, na.rm<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>The first part of the code <code>rdate = ymd("1960-01-01") + days(date)</code> creates a new variable that is named <code>rdate</code> which captures the date of the observation. The next <code>month=month(rdate)</code> extracts the month the observation was taken. The rest of the code then summarizes the amount of rainfall by month. In the end, we have a data frame with 12 observations, with each month associated with an average value of rain fall. Let's now plot those values over time.</p>
<div class="sourceCode" id="cb400"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">pm_bymonth</span><span class="op">$</span><span class="va">month</span>, <span class="va">pm_bymonth</span><span class="op">$</span><span class="va">meanrain</span>, </span>
<span>     col<span class="op">=</span><span class="st">"blue"</span>,</span>
<span>     pch<span class="op">=</span><span class="fl">16</span>, </span>
<span>     xlab<span class="op">=</span><span class="st">"Date"</span>, </span>
<span>     ylab<span class="op">=</span><span class="st">"Mean Daily Rain (mm)"</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="08-week8_files/figure-html/unnamed-chunk-38-1.png" width="75%"></div>
<p>China experiences much more rainfall May through September (i.e. months 5 through 9). Therefore, we might expect less pollution in these months. We can also see how this varies day-to-day. Instead of aggregating by month, let's generate a data frame that shows the amount of Daily Rain across China by day.</p>
<div class="sourceCode" id="cb401"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pm_byrdate</span> <span class="op">&lt;-</span> <span class="va">pm</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>rdate <span class="op">=</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/ymd.html">ymd</a></span><span class="op">(</span><span class="st">"1960-01-01"</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/period.html">days</a></span><span class="op">(</span><span class="va">date</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">rdate</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span>meanrain <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">rain</span>, na.rm<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Now let's plot rainfall over time:</p>
<div class="sourceCode" id="cb402"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">pm_byrdate</span><span class="op">$</span><span class="va">rdate</span>, <span class="va">pm_byrdate</span><span class="op">$</span><span class="va">meanrain</span>, </span>
<span>     col<span class="op">=</span><span class="st">"blue"</span>,</span>
<span>     pch<span class="op">=</span><span class="fl">16</span>, </span>
<span>     xlab<span class="op">=</span><span class="st">"Date"</span>, </span>
<span>     ylab<span class="op">=</span><span class="st">"Mean Daily Rain (mm)"</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="08-week8_files/figure-html/unnamed-chunk-40-1.png" width="75%"></div>
<p>Why are we looking at rain again? Well, what if automatic monitoring happened to be implemented at the end of the rainy season? In this case, we might expect to see increased pollution levels after automatic monitoring due to the changing seasons. In other words, rain fall is a potential confounding factor. We need to check that the change in pollution levels around automatic pollution monitoring isn't being driven by the changing seasons. We will return to this question in a later section.</p>
</div>
<div id="ggplot2" class="section level2" number="8.7">
<h2>
<span class="header-section-number">8.7</span> ggplot2<a class="anchor" aria-label="anchor" href="#ggplot2"><i class="fas fa-link"></i></a>
</h2>
<p>The functions we have used to generate figures so far all come from Base R. However, external packages have been written to provide more options when making figures. One of the most popular graphics packages is ggplot2. ggplot2 has two major strengths. First, you can use ggplot2 to create a variety of figures. Second, the syntax to create different types of figures is very similar. Therefore, once you learn how to generate a few figures, you will be able to quickly learn how to create many different types of figures. The "gg" in ggplot2 stands for the grammar of graphics, and that is the goal of ggplot2: to have a consistent language through which to build figures.</p>
<p>The philosophy to ggplot2 is that you want to build your graph in layers. The first layer is always the data, you always need to specify what data is going to be plotted. Then you will specify the aesthetics, which for our purposes you can think of as the variables that will be on your plot. Which variable will be on the horizontal axis? Which variable will be on the vertical axis? Then, we specify the type of plot. Is this a bar graph? Is it a line plot? In ggplot2, the type of graph is determined by the geometric function that you use. The basic syntax of a ggplot2 command that has all these components is shown below:</p>
<div class="sourceCode" id="cb403"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb403-1"><a href="automated-pollution-monitoring.html#cb403-1" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> <span class="sc">&lt;</span>DATA<span class="sc">&gt;</span>) <span class="sc">+</span> </span>
<span id="cb403-2"><a href="automated-pollution-monitoring.html#cb403-2" tabindex="-1"></a>  <span class="er">&lt;</span>GEOM_FUNCTION<span class="sc">&gt;</span>(<span class="at">mapping =</span> <span class="fu">aes</span>(<span class="sc">&lt;</span>MAPPINGS<span class="sc">&gt;</span>))</span>
<span id="cb403-3"><a href="automated-pollution-monitoring.html#cb403-3" tabindex="-1"></a> <span class="er">}</span></span></code></pre></div>
<p>We will replace the section <code>&lt;DATA&gt;</code> with whatever data we are using. In this next example, let's recreate the scatterplot that shows the average daily pollution levels relative to the automation date. If you recall, we already constructed a dataframe named <code>pm_byday</code> which contains for every day relative to automation (within a year), the average levels of pollution, as measured by PM10. However, for an example later in the section, we will also utilize a variable that captures mean rain by day. Therefore, let's construct a day-level dataset that contains for each day relative to automation, the average levels of PM10 and rain:</p>
<div class="sourceCode" id="cb404"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pm_byday</span> <span class="op">&lt;-</span> <span class="va">pm</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>T<span class="op">=</span><span class="va">date</span><span class="op">-</span><span class="va">auto_date</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="cn">T</span><span class="op">&gt;</span><span class="op">-</span><span class="fl">364</span>, <span class="cn">T</span><span class="op">&lt;</span><span class="fl">364</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="cn">T</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span>meanpm10 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">pm10</span>, na.rm<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    meanrain<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">rain</span>, na.rm<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>after<span class="op">=</span><span class="cn">T</span><span class="op">&gt;</span><span class="fl">0</span><span class="op">)</span></span></code></pre></div>
<p>For this example, we will replace <code>&lt;DATA&gt;</code> with <code>pm_byday</code>.</p>
<p><code>&lt;GEOM_FUNCTION&gt;</code> will be determine what type of plot appears. For example, <code>geom_point</code> is the geometric function to create a scatterplot. In this section, we will also discuss <code>geom_boxplot</code> and <code>geom_histogram</code>.</p>
<p><code>mapping = aes(&lt;MAPPINGS&gt;)</code> tells R what variables will appear in the graph. In our case, we want the x-axis to show the variable <code>T</code>. If you recall, <code>T</code> represents the day relative to automation. A negative number indicates automation has not yet occurred, while a positive indicates it has already occurred. On the y-axis we want to display the mean PM10 level, which is stored in the variable <code>meanpm10</code>. Therefore, the way we will specify the aesthetics will be <code>mapping=aes(x=T,y=meanpm10)</code>.</p>
<div class="sourceCode" id="cb405"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">pm_byday</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span>mapping <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="cn">T</span>, y <span class="op">=</span> <span class="va">meanpm10</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="08-week8_files/figure-html/unnamed-chunk-43-1.png" width="85%"></div>
<p>Again, there are many ways to customize our plot. In the next code, let's specify <code>color=blue</code> for the markers, as well as add axes labels and an overall title.</p>
<div class="sourceCode" id="cb406"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">pm_byday</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span>mapping <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="cn">T</span>, y <span class="op">=</span> <span class="va">meanpm10</span><span class="op">)</span>, color<span class="op">=</span><span class="st">"blue"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">xlab</a></span><span class="op">(</span><span class="st">"Time After Automation"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ylab</a></span><span class="op">(</span><span class="st">"Mean PM10"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op">(</span><span class="st">"Time After Automation and PM10"</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="08-week8_files/figure-html/unnamed-chunk-44-1.png" width="85%"></div>
<p>Finally, we can even color the dots by a different variables. For example, for each day relative to automation, we can color the marker by how much rain there was. This way, we can see if the automation date occurred around a change in the rain season. If so, then variation in pollution may be driven by variation in rain.</p>
<div class="sourceCode" id="cb407"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">pm_byday</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span>mapping <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="cn">T</span>, y <span class="op">=</span> <span class="va">meanpm10</span>,color<span class="op">=</span><span class="va">meanrain</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">xlab</a></span><span class="op">(</span><span class="st">"Time After Automation"</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ylab</a></span><span class="op">(</span><span class="st">"Mean PM10"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op">(</span><span class="st">"Time After Automation and PM10"</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="08-week8_files/figure-html/unnamed-chunk-45-1.png" width="85%"></div>
<p>In this graph, days in which there is a lot of rain are colored light blue, while days with less rain are colored dark blue. As you can see, around automation, the dots are mostly dark blue. This indicates this was a period in which there was relatively less rain. However, there doesn't seem to be a stark change just around the time of automation. In other words, the amount of rain seems relatively stable just before and just after automation of pollution monitoring.</p>
<p>Next, we are going to visualize the data in an alternative way: using a box plot. To do so we will use the <code>geom_boxplot</code> function.</p>
<!---
Extra repetitive discussion of box plots
To understand box plots theoretically, we are going to look at ages of Olympians for two different sports: Women's Gymnastics and Men's Curling. This box plot appears in Figure \@ref(fig:box1) below.

<div class="figure" style="text-align: center">
<img src="images/08_boxplot.png" alt="Boxplot of Ages for Different Olympic Sports" width="75%" />
<p class="caption">(\#fig:box1)Boxplot of Ages for Different Olympic Sports</p>
</div>

But what is represented on this figure? First, let's talk about the box itself. The box itself will tell you the 75th percentile, median, and 25th percentile:


<div class="figure" style="text-align: center">
<img src="images/08_boxplot_percentiles.png" alt="Understanding the Box" width="75%" />
<p class="caption">(\#fig:box2)Understanding the Box</p>
</div>

For example, for men's curling, the median age is 31. The difference between the 75th percentile and 25th percentile is referred to as the interquartile range (IQR). A larger IQR implies there is more spread in ages in the sport. 

Next, let's discuss the whiskers (i.e. the lines that extend from the boxes). The length of each whisker is $1.5 \times IQR$. 

<div class="figure" style="text-align: center">
<img src="images/08_boxplot_whisker.png" alt="Understanding the Whiskers" width="75%" />
<p class="caption">(\#fig:box3)Understanding the Whiskers</p>
</div>

However, sometimes there is absolutely no data at this point, so the whisker will stop early. For example, if we look at the Men's curling, the IQR is equal to 10. Therefore, if we extended down from the 25th percentile (which is equal to 27), then the whisker should reach $27-1.5 \times 10=12$. So why does it stop at 20? Well, the minimum age across all curlers is 20. the whisker will not extend past this minimum.

In some cases, however, there are observations beyond the length of the whiskers. For example, for Women's Gymnastic, we see a number of dots above the top whisker. This indicates there are individuals that have ages beyond the whisker, up to the maximum of 37.

Now that we understand theoretically what a box plot accomplishes, let's try one in our data.
--->
<div class="sourceCode" id="cb408"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">pm_byday</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_boxplot.html">geom_boxplot</a></span><span class="op">(</span>mapping<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>y<span class="op">=</span><span class="va">meanpm10</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="08-week8_files/figure-html/unnamed-chunk-46-1.png" width="75%"></div>
<p>Note that we did not specify an X-variable in the code above. If you add an X-variable to a boxplot, then the plot will be constructed separately for each value of the X-variable. Recall what our primary goal is here. We are interested in understanding how pollution changes following automation. So let's split this graph up by the variable <code>after</code> which is equal to 1 if automation has already occurred, and zero if it hasn't occurred yet.</p>
<div class="sourceCode" id="cb409"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">pm_byday</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_boxplot.html">geom_boxplot</a></span><span class="op">(</span>mapping<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">after</span>,y<span class="op">=</span><span class="va">meanpm10</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">xlab</a></span><span class="op">(</span><span class="st">"After Automation?"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ylab</a></span><span class="op">(</span><span class="st">"Pollution Levels"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op">(</span><span class="st">"Boxplot of Pollution Levels Before and After Automation"</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="08-week8_files/figure-html/unnamed-chunk-47-1.png" width="75%"></div>
</div>
<div id="bar-plots" class="section level2" number="8.8">
<h2>
<span class="header-section-number">8.8</span> Bar Plots<a class="anchor" aria-label="anchor" href="#bar-plots"><i class="fas fa-link"></i></a>
</h2>
<p>In this section we are going to discuss how to construct bar plots. We are going to focus on one aspect of Greenstone et al. (2022) that we haven't discussed in depth yet. In particular, we are going to study <em>how</em> automation was rolled out.</p>
<p>So far, we have discussed the automation date: the date after which pollution levels are automatically reported to the central government. Different cities, however, had different automated pollution dates. They implemented the policy first for a certain set of cities, and then second for another set of cities. In this section, we are going to try to figure out what the logic of that implementation was. In particular, did they target high-polluting cities as the first place to implement automated pollution monitoring?</p>
<p>The first thing we will do is again create a city-level dataset. This will be similar to the city-level datasets we have already created, but will also include a variable for the <code>phase</code> in which the city was included in automation. There are two possible values of <code>phase</code>, 1 for the first automation wave and 2 for the second wave of automation.</p>
<div class="sourceCode" id="cb410"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pm_bycity</span> <span class="op">&lt;-</span> <span class="va">pm</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>T <span class="op">=</span> <span class="va">date</span> <span class="op">-</span> <span class="va">auto_date</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="cn">T</span> <span class="op">&lt;</span> <span class="fl">0</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">code_city</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span>meanpm10 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">pm10</span>, na.rm<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>            phase <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">phase</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Note in the code below we have restricted to the period of time before automation (<code>filter(T&lt;0)</code>). The function <code>unique(phase)</code> takes the unique value of the phase for each city (this value does not vary within a city). Let's look at our resulting data frame:</p>
<div class="sourceCode" id="cb411"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">pm_bycity</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 6 × 3</span></span>
<span><span class="co">#&gt;   code_city meanpm10 phase</span></span>
<span><span class="co">#&gt;       &lt;dbl&gt;    &lt;dbl&gt; &lt;dbl&gt;</span></span>
<span><span class="co">#&gt; 1    110100    108.      1</span></span>
<span><span class="co">#&gt; 2    120100     93.3     1</span></span>
<span><span class="co">#&gt; 3    130100     92.5     1</span></span>
<span><span class="co">#&gt; 4    130200     84.8     1</span></span>
<span><span class="co">#&gt; 5    130300     66.4     1</span></span>
<span><span class="co">#&gt; 6    130400     94.7     1</span></span></code></pre></div>
<p>Next, let's create a bar plot using ggplot that shows the number of cities that were in phase 1 vs. phase 2. To do so we will continue to use the same syntax that we have learned in ggplot. Before looking at the figure, let's look at the code that will generate the figure:</p>
<div class="sourceCode" id="cb412"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">pm_bycity</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">phase</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_bar</a></span><span class="op">(</span>stat<span class="op">=</span><span class="st">"count"</span><span class="op">)</span></span></code></pre></div>
<p>Because <code>phase</code> is either 1 or 2, we want R to understand that <code>phase</code> is a categorical variable. By default, R will interpret this as a continuous variable. This is common for bar plots. We need to tell R we are showing statistics across groups (in this case the groups are the unique values of the <code>phase</code> variable).</p>
<p>We have specified <code>stat="count"</code> because in this example, we want to display the total number of cities for each value of <code>phase</code>. In other words, we want to count the number of cities by phase. Now that we understand the code, let's look at the figure itself.</p>
<div class="inline-figure"><img src="08-week8_files/figure-html/badbar-1.png" width="75%"></div>
<p>As we can see in this figure, about half of the cities in the sample (60) were in phase 1 of automation, while slightly more than half were in phase 2. What we need to do next is improve the appearence of the graph. The label <code>as.factor(phase)</code> is not particularly helpful for a reader. So let's add some custom labels and axes.</p>
<div class="sourceCode" id="cb413"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">pm_bycity</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">phase</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_bar</a></span><span class="op">(</span>stat<span class="op">=</span><span class="st">"count"</span>, fill<span class="op">=</span><span class="st">"darkblue"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">xlab</a></span><span class="op">(</span><span class="st">"Wave of Automation"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ylab</a></span><span class="op">(</span><span class="st">"Number of Cities"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op">(</span><span class="st">"Number of Cities by Wave of Automation"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_minimal</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="08-week8_files/figure-html/goodbar-1.png" width="75%"></div>
<p>We've introduced a few new things in the code above. First, we specified <code>fill="darkblue"</code>. This tells ggplot that instead of gray bars, we want the bars to be dark blue. Next, we have also specified <code><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_minimal()</a></code>. The nice thing about ggplot is that it also comes with a number of themes which can change the overall look of the graph. The <code>theme_minimual()</code> makes the plot look more minimalistic, taking out the background.</p>
<p>Next, we are going to study whether cities that were more polluted were more likely to be in the first wave. We will use a threshold of 80 to define whether a city is heavily polluted or not. So let's add a variable named <code>above80</code> to our data frame:</p>
<div class="sourceCode" id="cb414"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pm_bycity</span><span class="op">$</span><span class="va">above80</span> <span class="op">&lt;-</span> <span class="va">pm_bycity</span><span class="op">$</span><span class="va">meanpm10</span> <span class="op">&gt;</span> <span class="fl">80</span></span></code></pre></div>
<p>Now, we can use this variable to add another dimension to our bar plot. In particular, we can show what fraction of those in automation phase 1 had pollution levels above 80 vs. what fraction had pollution levels below 80. To do so, we will take out the code <code>fill="darkblue"</code> and add <code>fill=above80</code> inside <code><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes()</a></code>.</p>
<div class="sourceCode" id="cb415"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">pm_bycity</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">phase</span><span class="op">)</span>,fill<span class="op">=</span><span class="va">above80</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_bar</a></span><span class="op">(</span>stat<span class="op">=</span><span class="st">"count"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">xlab</a></span><span class="op">(</span><span class="st">"Wave of Automation"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ylab</a></span><span class="op">(</span><span class="st">"Number of Cities"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op">(</span><span class="st">"Number of Cities by Wave of Automation"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_minimal</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="08-week8_files/figure-html/coloredbar-1.png" width="75%"></div>
<p>How do we interpret this figure. Let's first focus on phase 1. There are slightly fewer than 40 cities which had average pollution levels of above 80 (the turquoise bar reaches to almost 40 in the figure). In total, there were about 60 cities in phase 1. So roughly two-thirds of the cities in phase 1 were high-polluting cities. Turning to phase 2, we can see about 30 cities were high-polluting cities, and the total number of cities is slightly higher than 60. Therefore, roughly half of cities were high-polluting in phase 2. So overall, there is some evidence that the high-polluting cities were more likely to be in wave 1. However, it is reasonably even split. There are a number of high-polluting cities in both waves of automation.</p>
<p>Next, we will explore a few more customizations. First, what we have plotted above is referred to as a stacked bar plot. We have divided cities into four groups: (phase 1 + high polluters), (phase 1 + low polluters), (phase 2 + high polluters), (phase 2 + low polluters). For each phase, the high and low polluters are stacked atop each other. We can instead specify to show the counts separately for these four groups.</p>
<p>To do so we will use the option <code>position = position_dodge()</code> inside <code><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_bar()</a></code>.</p>
<div class="sourceCode" id="cb416"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">pm_bycity</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">phase</span><span class="op">)</span>,fill<span class="op">=</span><span class="va">above80</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_bar</a></span><span class="op">(</span>stat<span class="op">=</span><span class="st">"count"</span>,position <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/position_dodge.html">position_dodge</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">xlab</a></span><span class="op">(</span><span class="st">"Wave of Automation"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ylab</a></span><span class="op">(</span><span class="st">"Number of Cities"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op">(</span><span class="st">"Number of Cities by Wave of Automation"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_minimal</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="08-week8_files/figure-html/dodgebar-1.png" width="75%"></div>
<p>This way of displaying the data may be a little bit more easily to visualize in certain cases. The last customization we will make is to change the legend. We can change both the text of the legend, as well as its position in the graph. To change the position, we can use add <code>theme(legend.position = "top")</code> to our graph. To change the text of the legend, we can use the <code><a href="https://ggplot2.tidyverse.org/reference/scale_colour_discrete.html">scale_fill_discrete()</a></code> option. For example, imagine we want to title the legend "Mean PM10 Above 80" and we also want to flip the order so that "TRUE" appears before "FALSE". The code below accomplishes both of these goals by specifying the proper elements inside <code><a href="https://ggplot2.tidyverse.org/reference/scale_colour_discrete.html">scale_fill_discrete()</a></code>.</p>
<div class="sourceCode" id="cb417"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">pm_bycity</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">phase</span><span class="op">)</span>, fill<span class="op">=</span><span class="va">above80</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_bar</a></span><span class="op">(</span>stat<span class="op">=</span><span class="st">"count"</span>, position <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/position_dodge.html">position_dodge</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">xlab</a></span><span class="op">(</span><span class="st">"Wave of Automation"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ylab</a></span><span class="op">(</span><span class="st">"Number of Cities"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op">(</span><span class="st">"Number of Cities by Wave of Automation"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_minimal</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"top"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_colour_discrete.html">scale_fill_discrete</a></span><span class="op">(</span>name<span class="op">=</span><span class="st">"Mean PM10 Above 80"</span>, </span>
<span>                      limits<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"TRUE"</span>, <span class="st">"FALSE"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="08-week8_files/figure-html/unnamed-chunk-52-1.png" width="75%"></div>
</div>
<div id="conclusion-6" class="section level2" number="8.9">
<h2>
<span class="header-section-number">8.9</span> Conclusion<a class="anchor" aria-label="anchor" href="#conclusion-6"><i class="fas fa-link"></i></a>
</h2>
<p>In this section we learned how to make a variety of plots, starting in base R, then moving onto ggplot2. In this final section, we are going to put everything we learned together. To illustrate the concepts, we are going to create side-by-side histograms, first in base R and then in ggplot2.</p>
<p>So let's first review the data frame we began with. We started with a Stata dataset named <code>station_day_1116.dta</code>. In order to load this data into R we used the <code>haven</code> package.</p>
<div class="sourceCode" id="cb418"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://haven.tidyverse.org">haven</a></span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb419"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://haven.tidyverse.org/reference/read_dta.html">read_dta</a></span><span class="op">(</span><span class="st">"station_day_1116.dta"</span><span class="op">)</span></span></code></pre></div>
<p>Our main goal is to study how pollution measurements change in response to automatic pollution monitoring. In China, local officials had incentives to manipulate pollution reports. Automated system was implemented in order to get accurate measures of pollution that cannot be manipulated by local officials. If we see pollution measurements increase around the time of automation, then that's good evidence of manipulation before automated pollution monitoring took place.</p>
<p>To understand the distribution of pollution measurements we are going to plot the distribution of mean PM10 by day both before and after automated monitoring. To do so we are again going to convert our data frame to a day-level dataset that has average levels of pollution per day.</p>
<div class="sourceCode" id="cb420"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pm_byday</span> <span class="op">&lt;-</span> <span class="va">pm</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>    T<span class="op">=</span><span class="va">date</span><span class="op">-</span><span class="va">auto_date</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="cn">T</span><span class="op">&gt;</span><span class="op">-</span><span class="fl">364</span>, <span class="cn">T</span><span class="op">&lt;</span><span class="fl">364</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="cn">T</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span>meanpm10 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">pm10</span>, na.rm<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    meanrain <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">rain</span>, na.rm<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>after<span class="op">=</span><span class="cn">T</span><span class="op">&gt;</span><span class="fl">0</span><span class="op">)</span></span></code></pre></div>
<p>Recall, <code>T=date-auto_date</code> will capture the days relative to automation. For example a value of -10 would indicate ten days <strong>until</strong> automation. A value of 10 will indicate ten days <strong>since</strong> automation. To create side-by-side histograms using base R we will first generate two additional data frames, one for before automation and one after automation:</p>
<div class="sourceCode" id="cb421"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">by_day_before</span> <span class="op">&lt;-</span> <span class="va">pm_byday</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">after</span><span class="op">==</span><span class="cn">FALSE</span><span class="op">)</span> </span>
<span><span class="va">by_day_after</span><span class="op">&lt;-</span> <span class="va">pm_byday</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">after</span><span class="op">==</span><span class="cn">TRUE</span><span class="op">)</span> </span></code></pre></div>
<p>Now, to generate side-by-side histograms in base R we need to use the <code>par(mfrow=c(1,2))</code>, which indicates there will be one row of plots and 2 columns.</p>
<p>Additionally, when we construct the figure we will make sure to (1) include proper labels, (2) make sure the limits of the axes are the same for both histograms and (3) have each graph be a different color.</p>
<div class="sourceCode" id="cb422"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span>mfrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/hist.html">hist</a></span><span class="op">(</span><span class="va">by_day_before</span><span class="op">$</span><span class="va">meanpm10</span>, col<span class="op">=</span><span class="st">"blue"</span>,</span>
<span>  xlab<span class="op">=</span><span class="st">"Mean PM10"</span>, </span>
<span>  main<span class="op">=</span><span class="st">"Before Automation"</span>,</span>
<span>  xlim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">200</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/hist.html">hist</a></span><span class="op">(</span><span class="va">by_day_after</span><span class="op">$</span><span class="va">meanpm10</span>, col<span class="op">=</span><span class="st">"red"</span>, </span>
<span>  xlab<span class="op">=</span><span class="st">"Mean PM10"</span>, </span>
<span>  main<span class="op">=</span><span class="st">"After Automation"</span>, </span>
<span>  xlim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">200</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="08-week8_files/figure-html/unnamed-chunk-57-1.png" width="75%"></div>
<p>Next, let's discuss how to make a similar plot in ggplot2. In order to do so, we actually have to load an external package <code>gridExtra</code>. To install an external package we type <code>install.packages("gridExtra")</code>. Then we need to load it into memory.</p>
<div class="sourceCode" id="cb423"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">gridExtra</span><span class="op">)</span></span></code></pre></div>
<p>Now, the first thing we are going to do is create both the histograms. Instead of having the plot displayed immediately, we will save the plot under a name. This will allow us to combine both the plots together using <code>gridExtra</code>. A convenient aspect of using ggplot for this problem will be that we don't actually have to create those intermediate data frame <code>by_day_before</code> and <code>by_day_after</code>. We can directly use <code>pm_byday</code>. Let's start by creating the histogram for before automation.</p>
<div class="sourceCode" id="cb424"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">plotbefore</span> <span class="op">&lt;-</span> <span class="va">pm_byday</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">after</span><span class="op">==</span><span class="cn">FALSE</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">meanpm10</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_histogram.html">geom_histogram</a></span><span class="op">(</span>fill<span class="op">=</span><span class="st">"blue"</span>, alpha<span class="op">=</span><span class="fl">.2</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">xlab</a></span><span class="op">(</span><span class="st">"Mean PM10"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op">(</span><span class="st">"Before Automation"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html">xlim</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">200</span><span class="op">)</span></span></code></pre></div>
<p>If you execute the code above, you will not see a plot appear in your Plots panel. That is because the plot has been stored under an object named <code>plotbefore</code> in your environment. If you type <code>plotbefore</code> and execute the code, then you will see the plot in the Plots window.</p>
<p>One aspect of the code we have not seen before is the option <code>alpha=0.2</code>. This parameter will change the transparency of the histogram. In other words, while the figure will be blue, it will be slightly transparent. Values closer to zero will be more transparent. Adding transparency to graphs can sometimes help, particularly when you have overlapping features.</p>
<p>Next, let's create <code>plotafter</code>. The only difference will be we will replace <code>filter(after==FALSE)</code> with <code>filter(after==TRUE)</code>.</p>
<div class="sourceCode" id="cb425"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">plotafter</span> <span class="op">&lt;-</span> <span class="va">pm_byday</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">after</span><span class="op">==</span><span class="cn">TRUE</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">meanpm10</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_histogram.html">geom_histogram</a></span><span class="op">(</span>fill<span class="op">=</span><span class="st">"red"</span>, alpha<span class="op">=</span><span class="fl">.2</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">xlab</a></span><span class="op">(</span><span class="st">"Mean PM10"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op">(</span><span class="st">"After Automation"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html">xlim</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">200</span><span class="op">)</span></span></code></pre></div>
<p>Now we can combine these two into a single plot.</p>
<div class="sourceCode" id="cb426"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/gridExtra/man/arrangeGrob.html">grid.arrange</a></span><span class="op">(</span><span class="va">plotbefore</span>, <span class="va">plotafter</span>, ncol<span class="op">=</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: Removed 2 rows containing missing values (`geom_bar()`).</span></span>
<span><span class="co">#&gt; Removed 2 rows containing missing values (`geom_bar()`).</span></span></code></pre></div>
<div class="inline-figure"><img src="08-week8_files/figure-html/unnamed-chunk-61-1.png" width="75%"></div>
<p>As we can see in these graphs, the distribution of pollution seems shifted to the right after automation. It appears that local officials may have been misreporting pollution levels prior to the policy. This specific finding is an important general lesson. In many situations, the one's making decisions (the officials) may not have the same incentives as those trying to implement the policy (the central government). This principal-agent problem is pervasive in many settings, but this paper has shown that there is a solution in some cases: technology. If you are interested in this topic, make sure to check out Greenstone et al. (2022) for more results!</p>
</div>
<div id="function-descriptions-2" class="section level2 unnumbered">
<h2>
<u>Function Descriptions</u><a class="anchor" aria-label="anchor" href="#function-descriptions-2"><i class="fas fa-link"></i></a>
</h2>
<div class="rmdnote">
<p><strong><u>Packages Used</u></strong></p>
<ul>
<li><p><code>tidyverse</code> -- Includes a suite of packages, including <code>ggplot2</code> which is used for graphics in this chapter.</p></li>
<li><p><code>haven</code> -- Allows users to read in Stata files into R.</p></li>
<li><p><code>lubridate()</code> -- A package useful for handling variables that contain dates in R.</p></li>
<li><p><code>gridExtra()</code> -- Allows user to put ggplot2 plots side-by-side</p></li>
</ul>
<p><strong><u>Base R plot functions</u></strong></p>
<ul>
<li><p><code><a href="https://rdrr.io/r/graphics/hist.html">hist()</a></code> -- Generates a histogram.</p></li>
<li><p><code><a href="https://rdrr.io/r/graphics/boxplot.html">boxplot()</a></code> -- Generates a boxplot.</p></li>
<li><p><code><a href="https://rdrr.io/r/graphics/plot.default.html">plot()</a></code> -- Generates a scatterplot.</p></li>
<li><p><code>par(mfrow=c(r,c))</code> -- Allows user to place base R plots in a grid. <code>r</code> is the number of rows and <code>c</code> is the number of columns. For example, <code>par(mfrow=c(1,2))</code> will imply that there will be 1 row and 2 columns of plots.</p></li>
</ul>
<p><strong><u>ggplot2 Geometric functions</u></strong></p>
<ul>
<li><p><code><a href="https://ggplot2.tidyverse.org/reference/geom_histogram.html">geom_histogram()</a></code> -- Generates a histogram.</p></li>
<li><p><code><a href="https://ggplot2.tidyverse.org/reference/geom_boxplot.html">geom_boxplot()</a></code> -- Generates a boxplot.</p></li>
<li><p><code><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point()</a></code> -- Generates a scatterplot</p></li>
<li><p><code><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_bar()</a></code> -- Generates a barplot.</p></li>
</ul>
</div>

</div>
</div>

<script>

/* update total correct if #webex-total_correct exists */
update_total_correct = function() {
  console.log("webex: update total_correct");

  if (t = document.getElementById("webex-total_correct")) {
    var correct = document.getElementsByClassName("webex-correct").length;
    var solvemes = document.getElementsByClassName("webex-solveme").length;
    var radiogroups = document.getElementsByClassName("webex-radiogroup").length;
    var selects = document.getElementsByClassName("webex-select").length;
    
    t.innerHTML = correct + " of " + (solvemes + radiogroups + selects) + " correct";
  }
}

/* webex-solution button toggling function */
b_func = function() {
  console.log("webex: toggle hide");
  
  var cl = this.parentElement.classList;
  if (cl.contains('open')) {
    cl.remove("open");
  } else {
    cl.add("open");
  }
}

/* function for checking solveme answers */
solveme_func = function(e) {
  console.log("webex: check solveme");

  var real_answers = JSON.parse(this.dataset.answer);
  var my_answer = this.value;
  var cl = this.classList;
  if (cl.contains("ignorecase")) {
    my_answer = my_answer.toLowerCase();
  }
  if (cl.contains("nospaces")) {
    my_answer = my_answer.replace(/ /g, "")
  }

  if (my_answer == "") {
    cl.remove("webex-correct");
    cl.remove("webex-incorrect");
  } else if (real_answers.includes(my_answer)) {
    cl.add("webex-correct");
    cl.remove("webex-incorrect");
  } else {
    cl.add("webex-incorrect");
    cl.remove("webex-correct");
  }

  // match numeric answers within a specified tolerance
  if(this.dataset.tol > 0){
    var tol = JSON.parse(this.dataset.tol);
    var matches = real_answers.map(x => Math.abs(x - my_answer) < tol)
    if (matches.reduce((a, b) => a + b, 0) > 0) {
      cl.add("webex-correct");
    } else {
      cl.remove("webex-correct");
    }
  }

  // added regex bit
  if (cl.contains("regex")){
    answer_regex = RegExp(real_answers.join("|"))
    if (answer_regex.test(my_answer)) {
      cl.add("webex-correct");
    }
  }

  update_total_correct();
}

/* function for checking select answers */
select_func = function(e) {
  console.log("webex: check select");
  
  var cl = this.classList
  
  /* add style */
  cl.remove("webex-incorrect");
  cl.remove("webex-correct");
  if (this.value == "answer") {
    cl.add("webex-correct");
  } else if (this.value != "blank") {
    cl.add("webex-incorrect");
  }
  
  update_total_correct();
}

/* function for checking radiogroups answers */
radiogroups_func = function(e) {
  console.log("webex: check radiogroups");

  var checked_button = document.querySelector('input[name=' + this.id + ']:checked');
  var cl = checked_button.parentElement.classList;
  var labels = checked_button.parentElement.parentElement.children;
  
  /* get rid of styles */
  for (i = 0; i < labels.length; i++) {
    labels[i].classList.remove("webex-incorrect");
    labels[i].classList.remove("webex-correct");
  }
  
  /* add style */
  if (checked_button.value == "answer") {
    cl.add("webex-correct");
  } else {
    cl.add("webex-incorrect");
  }
  
  update_total_correct();
}

window.onload = function() {
  console.log("onload");
  /* set up solution buttons */
  var buttons = document.getElementsByTagName("button");

  for (var i = 0; i < buttons.length; i++) {
    if (buttons[i].parentElement.classList.contains('webex-solution')) {
      buttons[i].onclick = b_func;
    }
  }

  /* set up webex-solveme inputs */
  var solveme = document.getElementsByClassName("webex-solveme");

  for (var i = 0; i < solveme.length; i++) {
    /* make sure input boxes don't auto-anything */
    solveme[i].setAttribute("autocomplete","off");
    solveme[i].setAttribute("autocorrect", "off");
    solveme[i].setAttribute("autocapitalize", "off");
    solveme[i].setAttribute("spellcheck", "false");
    solveme[i].value = "";

    /* adjust answer for ignorecase or nospaces */
    var cl = solveme[i].classList;
    var real_answer = solveme[i].dataset.answer;
    if (cl.contains("ignorecase")) {
      real_answer = real_answer.toLowerCase();
    }
    if (cl.contains("nospaces")) {
      real_answer = real_answer.replace(/ /g, "");
    }
    solveme[i].dataset.answer = real_answer;

    /* attach checking function */
    solveme[i].onkeyup = solveme_func;
    solveme[i].onchange = solveme_func;
  }
  
  /* set up radiogroups */
  var radiogroups = document.getElementsByClassName("webex-radiogroup");
  for (var i = 0; i < radiogroups.length; i++) {
    radiogroups[i].onchange = radiogroups_func;
  }
  
  /* set up selects */
  var selects = document.getElementsByClassName("webex-select");
  for (var i = 0; i < selects.length; i++) {
    selects[i].onchange = select_func;
  }

  update_total_correct();
}

</script><div class="chapter-nav">
<div class="prev"><a href="the-rug-rat-race.html"><span class="header-section-number">7</span> The Rug Rat Race</a></div>
<div class="next"><a href="voting.html"><span class="header-section-number">9</span> Voting</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#automated-pollution-monitoring"><span class="header-section-number">8</span> Automated Pollution Monitoring</a></li>
<li><a class="nav-link" href="#principal-agent-problem"><span class="header-section-number">8.1</span> Principal Agent Problem</a></li>
<li><a class="nav-link" href="#creating-histograms"><span class="header-section-number">8.2</span> Creating Histograms</a></li>
<li><a class="nav-link" href="#comparing-histograms"><span class="header-section-number">8.3</span> Comparing Histograms</a></li>
<li><a class="nav-link" href="#boxplots"><span class="header-section-number">8.4</span> Boxplots</a></li>
<li><a class="nav-link" href="#scatterplots"><span class="header-section-number">8.5</span> Scatterplots</a></li>
<li><a class="nav-link" href="#dates"><span class="header-section-number">8.6</span> Dates</a></li>
<li><a class="nav-link" href="#ggplot2"><span class="header-section-number">8.7</span> ggplot2</a></li>
<li><a class="nav-link" href="#bar-plots"><span class="header-section-number">8.8</span> Bar Plots</a></li>
<li><a class="nav-link" href="#conclusion-6"><span class="header-section-number">8.9</span> Conclusion</a></li>
<li><a class="nav-link" href="#function-descriptions-2">Function Descriptions</a></li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
          
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>Econ5/Poli5D</strong>" was written by David Arnold. It was last built on 2024-03-11.</p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer><!-- dynamically load mathjax for compatibility with self-contained --><script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script><script type="text/x-mathjax-config">const popovers = document.querySelectorAll('a.footnote-ref[data-toggle="popover"]');
for (let popover of popovers) {
  const div = document.createElement('div');
  div.setAttribute('style', 'position: absolute; top: 0, left:0; width:0, height:0, overflow: hidden; visibility: hidden;');
  div.innerHTML = popover.getAttribute('data-content');

  var has_math = div.querySelector("span.math");
  if (has_math) {
    document.body.appendChild(div);
    MathJax.Hub.Queue(["Typeset", MathJax.Hub, div]);
    MathJax.Hub.Queue(function() {
      popover.setAttribute('data-content', div.innerHTML);
      document.body.removeChild(div);
    })
  }
}
</script>
</body>
</html>
